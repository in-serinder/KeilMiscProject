C51 COMPILER V9.59.0.0   DS1302                                                            08/14/2025 09:24:42 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE DS1302
OBJECT MODULE PLACED IN .\Objects\DS1302.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE DS1302.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\DS
                    -1302.lst) TABS(2) OBJECT(.\Objects\DS1302.obj)

line level    source

   1          #include <DS1302.h>
              #include <Timer.h>
              
              sbit RST = P1 ^ 3;
              sbit IO = P1 ^ 2;
              sbit SCK = P1 ^ 1;
              
              /*
              DS1302å†…éƒ¨å¯„å­˜å™¨
              CH:æ—¶é’Ÿåœæ­¢ä½å¯„å­˜å™¨2çš„ç¬¬7ä½12/24å°æ—¶æ ‡å¿—
              CH=0æŒ¯è¡å™¨å·¥ä½œå…è®¸bit7=1,12å°æ—¶æ¨¡å¼
              CH=1æŒ¯è¡å™¨åœæ­¢bit7=0,24å°æ—¶æ¨¡å¼
              WP: å†™ä¿æŠ¤ä½å¯„å­˜å™¨2çš„ç¬¬5ä½:AM/PMå®šä¹‰
              WP=0å¯„å­˜å™¨æ•°æ®èƒ½å¤Ÿå†™å…¥ AP=1   ä¸‹åˆæ¨¡å¼
              WP=1å¯„å­˜å™¨æ•°æ®ä¸èƒ½å†™å…¥ AP=0   ä¸Šåˆæ¨¡å¼
                   TCS: æ¶“æµå……ç”µé€‰æ‹©                    DS: äºŒæç®¡é€‰æ‹©ä½
                   TCS=1010    ä½¿èƒ½æ¶“æµå……ç”µ            DS=01     é€‰æ‹©ä¸€ä¸ªäºŒæç®¡
                   TCS=å…¶å®ƒ    ç¦æ­¢æ¶“æµå……ç”µ            DS=10     é€‰æ‹©ä¸¤ä¸ªäºŒæç®¡
                   DS=00æˆ–11, å³ä½¿TCS=1010, å……ç”µåŠŸèƒ½ä¹Ÿè¢«ç¦
              */
              
              #define ds1302_sec_add 0x80     // ç§’
              #define ds1302_min_add 0x82     // åˆ†
              #define ds1302_hr_add 0x84      // æ—¶
              #define ds1302_date_add 0x86    // æ—¥
              #define ds1302_month_add 0x88   // æœˆ
              #define ds1302_day_add 0x8a     // å‘¨
              #define ds1302_year_add 0x8c    // å¹´
              #define ds1302_control_add 0x8e // æ•°æ®æ§åˆ¶
              #define ds1302_charger_add 0x90
              #define ds1302_clkburst_add 0xbe
              
              unsigned char time_buf[8] = {0x20, 0x10, 0x09, 0x14, 0x23, 0x59, 0x50, 0x02}; // æ—¥æœŸä»¥åå…­è¿›åˆ¶å­˜å
             -‚¨
              char TimeStr[18];
              // unsigned char readtime[14];
              // uchar sec_buf = 0;
              // uchar sec_flag = 0;
              
              void DS1302_Init()
              {
                  RST = 0;
                  SCK = 0;
              }
              
              void writeByte(unsigned char addr, unsigned char dat)
              {
                  unsigned char i;
                  RST = 0; // å¯åŠ¨æ€»çº¿
              
                  // å†™å…¥åˆ°æŒ‡å®šåœ°å€
              
                  addr &= 0xFE; // æœ€ä½ä½è‡³0ï¼Œ0å†™1è¯»
              
C51 COMPILER V9.59.0.0   DS1302                                                            08/14/2025 09:24:42 PAGE 2   

                  for (i = 0; i < 8; i++)
                  {
                      if (addr & 0x01)
                      {
                          IO = 1;
                      }
                      else
                      {
                          IO = 0;
                      }
              
                      SCK = 1;
                      SCK = 0; // äº§ç”Ÿä¸€ä¸ªæ—¶é’Ÿ
              
                      addr = addr >> 1; // å³ç§»
                  }
              
                  // å†™å…¥æ•°æ®
                  for (i = 0; i < 8; i++)
                  {
                      if (dat & 0x01)
                      {
                          IO = 1;
                      }
                      else
                      {
                          IO = 0;
                      }
                      SCK = 1;
                      SCK = 0;
                      dat = dat >> 1;
                  }
                  RST = 0;
              }
              
              unsigned char readByte(unsigned addr)
              {
                  unsigned char i, dat;
                  RST = 1;
              
                  addr |= 0x01;
              
                  for (i = 0; i < 8; i++)
                  {
                      if (addr & 0x01)
                      {
                          IO = 1;
                      }
                      else
                      {
                          IO = 0;
                      }
                      SCK = 1;
                      SCK = 0;
              
                      addr = addr >> 1;
                  }
              
                  // è¾“å‡ºåˆ°temp
                  for (i = 0; i < 8; i++)
                  {
                      dat = dat >> 1; // å³ç§»å­˜å‚¨
C51 COMPILER V9.59.0.0   DS1302                                                            08/14/2025 09:24:42 PAGE 3   

                      if (IO)
                      {
                          dat |= 0x80;
                      }
                      else
                      {
                          dat &= 0x7F;
                      }
                      SCK = 1;
                      SCK = 0;
                  }
                  RST = 0;
                  return dat;
              }
              
              void DS1302WriteTime()
              {
                  writeByte(ds1302_control_add, 0x00); // å…³é—­å†™ä¿æŠ¤
                  writeByte(ds1302_sec_add, 0x80);
                  // writeByte(ds1302_charger_add,0xa9); //æ¶“æµå……ç”µ
                  writeByte(ds1302_year_add, time_buf[1]);
                  writeByte(ds1302_month_add, time_buf[2]);
                  writeByte(ds1302_date_add, time_buf[3]);
                  writeByte(ds1302_hr_add, time_buf[4]);
                  writeByte(ds1302_min_add, time_buf[5]);
                  writeByte(ds1302_sec_add, time_buf[6]);
                  writeByte(ds1302_day_add, time_buf[7]);
                  writeByte(ds1302_control_add, 0x80);
              }
              
              void readTime()
              {
                  time_buf[1] = readByte(ds1302_year_add);
                  time_buf[2] = readByte(ds1302_month_add);
                  time_buf[3] = readByte(ds1302_date_add);
                  time_buf[4] = readByte(ds1302_hr_add);
                  time_buf[5] = readByte(ds1302_min_add);
                  time_buf[6] = readByte(ds1302_sec_add) & 0x7f; // ç›´æ¥è¯»å–ç§’å¯„å­˜å™¨åœ°å€
                  time_buf[7] = readByte(ds1302_day_add);
              }
              
              char *getTimerString()
              {
                  // unsigned char i;
                  readTime();
                  // // å¹´
                  // TimeStr[0] = (time_buf[0] >> 4);
                  // TimeStr[1] = (time_buf[0] & 0x0F);
              
                  // TimeStr[2] = (time_buf[1] >> 4);
                  // TimeStr[3] = (time_buf[1] & 0x0F);
                  // TimeStr[4] = '-';
              
                  // // æœˆ
                  // TimeStr[5] = (time_buf[1] >> 4);
                  // TimeStr[6] = (time_buf[1] & 0x0F);
                  // TimeStr[7] = '-';
                  // // æ—¥
                  // TimeStr[8] = (time_buf[1] >> 4);
                  // TimeStr[9] = (time_buf[1] & 0x0F);
                  // TimeStr[10] = '-';
                  // // æ—¶
C51 COMPILER V9.59.0.0   DS1302                                                            08/14/2025 09:24:42 PAGE 4   

                  // TimeStr[11] = (time_buf[1] >> 4);
                  // TimeStr[12] = (time_buf[1] & 0x0F);
                  // TimeStr[13] = ':';
                  // // åˆ†
                  // TimeStr[14] = (time_buf[1] >> 4);
                  // TimeStr[15] = (time_buf[1] & 0x0F);
                  // TimeStr[16] = ':';
                  // // ç§’
                  // TimeStr[17] = (time_buf[1] >> 4);
                  // TimeStr[18] = (time_buf[1] & 0x0F);
              
                  // å¹´
              
                  TimeStr[0] = (time_buf[1] >> 4) + '0';
                  TimeStr[1] = (time_buf[1] & 0x0F) + '0';
                  TimeStr[2] = '-';
              
                  // æœˆ
                  TimeStr[3] = (time_buf[2] >> 4) + '0';
                  TimeStr[4] = (time_buf[2] & 0x0F) + '0';
                  TimeStr[5] = '-';
                  // æ—¥
                  TimeStr[6] = (time_buf[3] >> 4) + '0';
                  TimeStr[7] = (time_buf[3] & 0x0F) + '0';
                  TimeStr[8] = '-';
                  // æ—¶
                  TimeStr[9] = (time_buf[4] >> 4) + '0';
                  TimeStr[10] = (time_buf[4] & 0x0F) + '0';
                  TimeStr[11] = ':';
                  // åˆ†
                  TimeStr[12] = (time_buf[5] >> 4) + '0';
                  TimeStr[13] = (time_buf[5] & 0x0F) + '0';
                  TimeStr[14] = ':';
                  // ç§’
                  TimeStr[15] = (time_buf[6] >> 4) + '0';
                  TimeStr[16] = (time_buf[6] & 0x0F) + '0';
              
                  TimeStr[17] = '\0';
              
                  return TimeStr;
              }
*** WARNING C316 IN LINE 218 OF DS1302.c: unterminated conditionals


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   ----    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
